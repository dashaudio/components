<link rel="import" href="../bower/polymer/polymer.html">
<link rel="import" href="../bower/google-chart/google-chart.html">

<dom-module id="dash-chart-cohort">
  <template>
    <style>
      .container {
        width: 100%; height: 100%;
        overflow: hidden;
      }
      google-chart {
        width: 100%; height: 100%;
      }
    </style>
    <div class="container">
      <google-chart options="{{options}}" type="{{type}}" cols="{{cols}}" rows="{{rows}}"></google-chart>
    </div>
  </template>
</dom-module>

<script>

  Polymer({

    is: 'dash-chart-cohort',

    properties: {
      options: Object,
      type: String,
      cols: Array,
      rows: Array,
      data: {
        type: Array,
        observer: "dataChanged"
      }
    },

    ready: function() {

      this.options = {
        width: "100%",
        height: "100%",
        pointSize: 5,
        colors: ["#00BFFF", "#FA1C68", "#FB7D34", "#00ACF3"]
        // bar: { groupWidth: "80%" },
        // chartArea:{
        //   left: 50,
        //   right: 0,
        //   bottom: 10,
        //   top: 10,
        //   width: "100%",
        //   height: "100%"
        // },
        // fontSize: 12,
        // hAxis: { gridlines: { color: "#eee" } },
        // vAxis: { gridlines: { color: "#eee" } },
        // legend: { position: "none" }
      };

      this.type = "line";

    },

    dataChanged: function(data) {
      if (data) this.refresh(data);
    },

    refresh: function(data) {

      // TODO: Code is horrible, but we'll clean this up, maybe there's a better API for this setup.

      var firstCol = [{ label: "Month", type: "string" }];

      var cols = firstCol.concat(data.monthsList.map(function(month, index) {
        return { label: "Cohort " + (index + 1), type: "number" };
      }));

      var rows = data.monthsList.map(function(month, index) {
        return ["Month " + (index + 1)];
      });

      var monthsCount = data.monthsList.length;
      var cohortCount = Array.from(new Set(data.buckets.map(function(b) { return b.cohort; }))).length;

      for (var m = 0; m < monthsCount; m++) {
        for (var c = 1; c <= cohortCount; c++) {
          rows[m][c] = null;
        }
      }

      data.buckets.forEach(function(bucket) {
        rows[bucket.month - 1][bucket.cohort] = bucket.value;
      });

      this.set("rows", rows);
      this.set("cols", cols);

    }

  });

</script>
